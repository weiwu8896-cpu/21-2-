<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çµå¢ƒ 21 ç‚¹ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        :root { --gold: #d4af37; --cyan: #00ffff; --red: #ff4757; }
        body { margin: 0; background: #000; color: white; font-family: 'PingFang SC', sans-serif; overflow: hidden; }
        
        /* å…³é”®ä¿®å¤ï¼šç¡®ä¿ç”»å¸ƒé“ºæ»¡å¹¶ç½®äºåº•å±‚ */
        #output_canvas { 
            position: fixed; inset: 0; z-index: 1; 
            width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); 
            opacity: 0.6; /* è°ƒé«˜äº®åº¦è®©ä½ çœ‹æ¸…è‡ªå·± */
        }
        
        #game-ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px; box-sizing: border-box; pointer-events: none; }
        .stats-bar { display: flex; gap: 40px; background: rgba(0,0,0,0.85); padding: 15px 40px; border-radius: 50px; border: 1px solid var(--gold); box-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .stat-val { color: var(--gold); font-size: 28px; font-weight: bold; }
        .hand { display: flex; gap: 15px; min-height: 160px; }
        .card { width: 100px; height: 150px; background: white; color: black; border-radius: 12px; padding: 10px; box-sizing: border-box; font-weight: bold; font-size: 22px; animation: deal 0.5s ease-out; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        @keyframes deal { from { transform: translateY(-400px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #main-hint { font-size: 1.5em; color: var(--cyan); text-align: center; background: rgba(0,0,0,0.6); padding: 20px 40px; border-radius: 50px; border: 1px solid var(--cyan); text-shadow: 0 0 10px #000; }
        #status-info { position: fixed; top: 10px; left: 10px; z-index: 100; font-size: 12px; color: #00ff00; }
    </style>
</head>
<body>

<div id="status-info">ç³»ç»Ÿè‡ªæ£€ä¸­...</div>
<video id="input_video" style="display:none;" playsinline></video>
<canvas id="output_canvas"></canvas>

<div id="game-ui">
    <div class="stats-bar">
        <div style="text-align:center">èµ„äº§<div id="m-val" class="stat-val">$1000</div></div>
        <div style="text-align:center">ä¸‹æ³¨<div id="b-val" class="stat-val">$0</div></div>
    </div>

    <div id="dealer-hand" class="hand"></div>

    <div id="main-hint">è¯·ç¨å€™ï¼Œæ­£åœ¨åŠ è½½è¯†åˆ«æ¨¡å‹...</div>

    <div id="player-zone">
        <div id="player-hand" class="hand"></div>
        <div id="player-score" style="text-align:center; color:var(--gold); font-size: 2em; margin-top:10px; font-weight:bold;">ç‚¹æ•°: 0</div>
    </div>
</div>

<script>
let money = 1000, bet = 0, state = "BETTING", pHand = [], dHand = [], deck = [];
let holdType = "NONE", holdTime = 0;

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status-info');

// 1. åˆå§‹åŒ–æ‰‹åŠ¿è¯†åˆ«å¼•æ“
const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

// 2. è¯†åˆ«ç»“æœå¤„ç†é€»è¾‘
hands.onResults((results) => {
    status.innerText = "â— è¯†åˆ«å¼•æ“å·²å°±ç»ª";
    
    // å…³é”®ä¿®å¤ï¼šåŠ¨æ€è°ƒæ•´ç”»å¸ƒå°ºå¯¸åŒ¹é…çª—å£
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ç»˜åˆ¶é•œåƒèƒŒæ™¯
    ctx.scale(-1, 1);
    ctx.translate(-canvas.width, 0);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const lm = results.multiHandLandmarks[0];
        
        // åœ¨ç”»é¢ä¸Šç”»å‡ºéª¨æ¶ï¼ˆå¦‚æœèƒ½çœ‹åˆ°ç»¿çº¿ï¼Œè¯´æ˜è¯†åˆ«é€šäº†ï¼‰
        drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
        drawLandmarks(ctx, lm, {color: '#FF0000', lineWidth: 2});

        // è¯†åˆ«åŠ¨ä½œï¼šé£ŸæŒ‡å‘ä¸Š or æ‰‹æŒå‘ä¸Š
        const isIndexUp = lm[8].y < lm[6].y;
        const isMiddleUp = lm[12].y < lm[10].y;
        const isRingUp = lm[16].y < lm[14].y;

        let detected = "NONE";
        if (isIndexUp && !isMiddleUp) detected = "HIT"; 
        else if (isIndexUp && isMiddleUp && isRingUp) detected = "STAND";

        if (detected !== "NONE" && detected === holdType) {
            holdTime++;
            if (holdTime > 20) { 
                handleGame(detected); 
                holdTime = 0; 
            }
        } else {
            holdType = detected;
            holdTime = 0;
        }
    }
    ctx.restore();
});

// 3. å¯åŠ¨æ‘„åƒå¤´
const camera = new Camera(video, {
    onFrame: async () => {
        await hands.send({image: video});
    },
    width: 1280,
    height: 720
});

window.onload = () => {
    camera.start().then(() => {
        document.getElementById('main-hint').innerHTML = "â˜ï¸ ä¿æŒé£ŸæŒ‡ï¼šåŠ æ³¨ ($100)<br>ğŸ–ï¸ ä¿æŒæ‰‹æŒï¼šç¡®è®¤å¼€å±€";
    });
};

// 4. æ¸¸æˆæ§åˆ¶é€»è¾‘
function handleGame(type) {
    if (state === "BETTING") {
        if (type === "HIT" && money >= 100) { bet += 100; money -= 100; }
        else if (type === "STAND" && bet > 0) {
            state = "PLAYING";
            initDeck();
            pHand = [deck.pop(), deck.pop()]; dHand = [deck.pop()];
            pHand.forEach(c => renderCard(c, 'player-hand'));
            dHand.forEach(c => renderCard(c, 'dealer-hand'));
            document.getElementById('main-hint').innerHTML = "â˜ï¸ ä¿æŒé£ŸæŒ‡ï¼šè¦ç‰Œ (Hit)<br>ğŸ–ï¸ ä¿æŒæ‰‹æŒï¼šåœç‰Œ (Stand)";
        }
    } else if (state === "PLAYING") {
        if (type === "HIT") {
            const c = deck.pop(); pHand.push(c); renderCard(c, 'player-hand');
            if (getScore(pHand) > 21) { alert("ä½ çˆ†ç‰Œäº†ï¼"); location.reload(); }
        } else if (type === "STAND") {
            state = "DEALER";
            while(getScore(dHand) < 17) { dHand.push(deck.pop()); renderCard(dHand[dHand.length-1], 'dealer-hand'); }
            const ps = getScore(pHand), ds = getScore(dHand);
            alert((ds > 21 || ps > ds) ? "ä½ èµ¢äº†ï¼" : (ps === ds ? "å¹³å±€" : "åº„å®¶èµ¢äº†ï¼"));
            location.reload();
        }
    }
    updateUI();
}

function initDeck() {
    const suits = ['â™ ','â™¥','â™£','â™¦'], vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    deck = [];
    suits.forEach(s => vals.forEach(v => deck.push({s, v, isRed: (s==='â™¥'||s==='â™¦')})));
    deck.sort(() => Math.random() - 0.5);
}

function getScore(hand) {
    let s = 0, a = 0;
    hand.forEach(c => { if(c.v==='A'){a++;s+=11} else if(['J','Q','K'].includes(c.v))s+=10; else s+=parseInt(c.v); });
    while(s>21 && a>0){s-=10;a--} return s;
}

function renderCard(c, id) {
    const d = document.createElement('div');
    d.className = `card ${c.isRed ? 'red' : ''}`;
    d.innerHTML = `<div>${c.v}</div><div style="font-size:45px;text-align:center;margin-top:20px">${c.s}</div>`;
    document.getElementById(id).appendChild(d);
}

function updateUI() {
    document.getElementById('m-val').innerText = `$${money}`;
    document.getElementById('b-val').innerText = `$${bet}`;
    document.getElementById('player-score').innerText = `ç‚¹æ•°: ${getScore(pHand)}`;
}
</script>
</body>
</html>

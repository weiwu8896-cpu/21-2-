<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çµå¢ƒ 21 ç‚¹ - å…¨æ‰‹æ§å¹»å¢ƒç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        :root { --gold: #d4af37; --cyan: #00ffff; --red: #ff4757; --purple: #6c5ce7; }
        
        body { 
            margin: 0; 
            background: radial-gradient(circle at center, #1a1a2e 0%, #05050a 100%) !important; 
            color: white; 
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; 
            overflow: hidden; 
        }

        /* åŠ¨æ€èƒŒæ™¯ç²’å­æ„Ÿï¼ˆCSS æ¨¡æ‹Ÿï¼‰ */
        body::before {
            content: ""; position: fixed; inset: 0;
            background-image: radial-gradient(rgba(212, 175, 55, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: move-bg 20s linear infinite;
            z-index: -1;
        }
        @keyframes move-bg { from { transform: translateY(0); } to { transform: translateY(500px); } }

        /* æ‘„åƒå¤´å°æ¡†ï¼šå¸¦å‘¼å¸ç¯éœ“è™¹ */
        #output_canvas { 
            position: fixed !important; bottom: 30px !important; right: 30px !important; 
            z-index: 1000 !important; width: 220px !important; height: 165px !important; 
            border: 2px solid var(--gold); border-radius: 15px;
            transform: scaleX(-1); background: #000;
            box-shadow: 0 0 15px var(--gold), inset 0 0 10px rgba(212,175,55,0.5);
            animation: neon-glow 2s ease-in-out infinite alternate;
        }
        @keyframes neon-glow { from { box-shadow: 0 0 10px var(--gold); } to { box-shadow: 0 0 25px var(--cyan); } }

        #game-ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 20px; }
        
        /* é…·ç‚«çŠ¶æ€æ  */
        .stats-bar { 
            display: flex; gap: 60px; background: rgba(0,0,0,0.8); 
            padding: 20px 50px; border-radius: 20px; 
            border-bottom: 3px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 12px; color: #aaa; letter-spacing: 2px; margin-bottom: 5px; }
        .stat-val { color: var(--gold); font-size: 32px; font-weight: bold; font-family: 'Courier New', monospace; }

        /* å¡ç‰Œæ ·å¼å‡çº§ */
        .hand { display: flex; gap: 20px; min-height: 160px; justify-content: center; align-items: center; }
        .card { 
            width: 100px; height: 150px; background: #fff; color: #000; border-radius: 12px; 
            padding: 10px; box-sizing: border-box; font-weight: bold; font-size: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.7);
            border: 1px solid #ddd;
            animation: card-appear 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .card.hidden-card { 
            background: repeating-linear-gradient(45deg, #1a1a2e, #1a1a2e 10px, #16213e 10px, #16213e 20px);
            border: 3px solid var(--gold); color: transparent; 
        }
        .card.red-suit { color: var(--red); }
        @keyframes card-appear { from { transform: scale(0) rotate(-45deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }

        /* å…¨å±å¼•å¯¼ */
        #main-hint { 
            font-size: 1.4em; color: var(--cyan); background: rgba(0,0,0,0.7); 
            padding: 20px 50px; border-radius: 50px; border: 1px solid rgba(0,255,255,0.3);
            text-shadow: 0 0 10px var(--cyan);
        }
        
        /* ç»“ç®—å¼¹çª— - å¢åŠ è¿›åº¦æ¡æç¤º */
        #overlay { 
            position: fixed; inset: 0; background: rgba(5,5,15,0.95); 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; 
        }
        .auto-next-bar { width: 300px; height: 4px; background: #333; margin-top: 30px; border-radius: 2px; overflow: hidden; }
        #progress { width: 0%; height: 100%; background: var(--gold); transition: width 0.1s; }
    </style>
</head>
<body>

<video id="input_video" style="display:none;" playsinline></video>
<canvas id="output_canvas"></canvas>

<div id="game-ui">
    <div class="stats-bar">
        <div class="stat-item"><div class="stat-label">CHIPS</div><div id="m-val" class="stat-val">$1000</div></div>
        <div class="stat-item"><div class="stat-label">BET</div><div id="b-val" class="stat-val">$0</div></div>
    </div>

    <div>
        <div style="text-align:center; color:var(--gold); letter-spacing: 5px; opacity:0.6">DEALER</div>
        <div id="dealer-hand" class="hand"></div>
    </div>

    <div id="main-hint">ğŸ”® æ­£åœ¨å”¤é†’çµå¢ƒæ„Ÿåº”...</div>

    <div>
        <div id="player-hand" class="hand"></div>
        <div id="player-score" style="text-align:center; color:var(--cyan); font-size: 2.2em; margin-top:10px; font-weight:bold;">0</div>
        <div style="text-align:center; color:var(--cyan); letter-spacing: 5px; opacity:0.6">PLAYER</div>
    </div>
</div>

<div id="overlay">
    <h1 id="res-title" style="font-size: 4em; letter-spacing: 10px;"></h1>
    <p id="res-detail" style="font-size: 1.5em; color: #888;"></p>
    <div style="margin-top:40px; color:var(--gold)">ğŸ–ï¸ ä¿æŒå¼ å¼€æ‰‹æŒï¼Œè‡ªåŠ¨å¼€å¯ä¸‹ä¸€å±€</div>
    <div class="auto-next-bar"><div id="progress"></div></div>
</div>

<script>
let money = 1000, bet = 0, state = "BETTING", pHand = [], dHand = [], deck = [];
let holdType = "NONE", holdTime = 0, busy = false;

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');

const wait = (ms) => new Promise(r => setTimeout(r, ms));

function shuffle() {
    const suits = ['â™ ','â™¥','â™£','â™¦'], vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let d = [];
    suits.forEach(s => vals.forEach(v => d.push({s, v, isRed: (s==='â™¥'||s==='â™¦')})));
    return d.sort(() => Math.random() - 0.5);
}

function drawCard(card, containerId, isHidden = false) {
    const el = document.createElement('div');
    el.className = `card ${isHidden ? 'hidden-card' : ''} ${card.isRed ? 'red-suit' : ''}`;
    el.innerHTML = isHidden ? '' : `<div>${card.v}</div><div style="font-size:40px;text-align:center;margin-top:20px">${card.s}</div><div style="text-align:right; font-size:16px">${card.v}</div>`;
    document.getElementById(containerId).appendChild(el);
}

async function dealStart() {
    busy = true;
    deck = shuffle(); pHand = []; dHand = [];
    document.getElementById('player-hand').innerHTML = '';
    document.getElementById('dealer-hand').innerHTML = '';
    
    const p1 = deck.pop(); pHand.push(p1); drawCard(p1, 'player-hand'); await wait(600);
    const d1 = deck.pop(); dHand.push(d1); drawCard(d1, 'dealer-hand'); await wait(600);
    const p2 = deck.pop(); pHand.push(p2); drawCard(p2, 'player-hand'); await wait(600);
    const d2 = deck.pop(); dHand.push(d2); drawCard(d2, 'dealer-hand', true);
    
    state = "PLAYING"; busy = false; updateUI();
    document.getElementById('main-hint').innerHTML = "â˜ï¸ ä¿æŒé£ŸæŒ‡ï¼šè¦ç‰Œ (Hit) | ğŸ–ï¸ ä¿æŒæ‰‹æŒï¼šåœç‰Œ (Stand)";
}

async function action(type) {
    if (busy) return;
    
    // å¦‚æœæ˜¯ç»“ç®—çŠ¶æ€ï¼Œæ‰‹æŒç”¨æ¥è§¦å‘é‡å¯
    if (state === "FINISHED") {
        if (type === "STAND") {
            holdTime++;
            document.getElementById('progress').style.width = (holdTime * 5) + "%";
            if (holdTime > 20) { resetRound(); holdTime = 0; }
        } else {
            holdTime = 0;
            document.getElementById('progress').style.width = "0%";
        }
        return;
    }

    if (state === "BETTING") {
        if (type === "HIT" && money >= 100) { bet += 100; money -= 100; updateUI(); }
        else if (type === "STAND" && bet > 0) { state = "DEALING"; dealStart(); }
    } else if (state === "PLAYING") {
        if (type === "HIT") {
            busy = true;
            const c = deck.pop(); pHand.push(c); drawCard(c, 'player-hand');
            updateUI();
            if (getScore(pHand) > 21) { await wait(1000); finalize("LOSE", "BUSTED", "ä½ çˆ†ç‰Œäº†ï¼Œç­¹ç å½’åº„å®¶"); }
            else { busy = false; }
        } else if (type === "STAND") {
            busy = true;
            document.getElementById('main-hint').innerText = "åº„å®¶æ­ç‰Œ...";
            const dh = document.getElementById('dealer-hand');
            dh.lastChild.classList.remove('hidden-card');
            dh.lastChild.innerHTML = `<div>${dHand[1].v}</div><div style="font-size:40px;text-align:center;margin-top:20px">${dHand[1].s}</div><div style="text-align:right; font-size:16px">${dHand[1].v}</div>`;
            await wait(1000);
            while(getScore(dHand) < 17) {
                const c = deck.pop(); dHand.push(c); drawCard(c, 'dealer-hand'); await wait(1000);
            }
            const ps = getScore(pHand), ds = getScore(dHand);
            if (ds > 21) finalize("WIN", "WINNER", "åº„å®¶çˆ†ç‰Œï¼Œèµ¢å¾—åŒå€ç­¹ç ï¼");
            else if (ps > ds) finalize("WIN", "WINNER", "ç‚¹æ•°ç¢¾å‹ï¼Œæ­å–œè·èƒœï¼");
            else if (ps < ds) finalize("LOSE", "DEALER WON", "åº„å®¶æŠ€é«˜ä¸€ç­¹");
            else finalize("PUSH", "PUSH", "åŒæ–¹æ¡æ‰‹è¨€å’Œ");
        }
    }
}

function getScore(hand) {
    let s = 0, a = 0;
    hand.forEach(c => { if(c.v==='A'){a++;s+=11} else if(['J','Q','K'].includes(c.v))s+=10; else s+=parseInt(c.v); });
    while(s>21 && a>0){s-=10;a--} return s;
}

function finalize(res, title, msg) {
    if (res === "WIN") money += bet * 2;
    if (res === "PUSH") money += bet;
    state = "FINISHED";
    document.getElementById('res-title').innerText = title;
    document.getElementById('res-title').style.color = res === "WIN" ? "var(--cyan)" : (res === "LOSE" ? "var(--red)" : "var(--gold)");
    document.getElementById('res-detail').innerText = msg;
    document.getElementById('overlay').style.display = "flex";
}

function resetRound() {
    bet = 0; pHand = []; dHand = []; state = "BETTING"; busy = false; holdTime = 0;
    document.getElementById('player-hand').innerHTML = '';
    document.getElementById('dealer-hand').innerHTML = '';
    document.getElementById('overlay').style.display = "none";
    document.getElementById('main-hint').innerHTML = "â˜ï¸ ä¿æŒé£ŸæŒ‡ï¼šä¸‹æ³¨ ($100) | ğŸ–ï¸ ä¿æŒæ‰‹æŒï¼šç¡®è®¤å¼€å±€";
    updateUI();
}

function updateUI() {
    document.getElementById('m-val').innerText = `$${money}`;
    document.getElementById('b-val').innerText = `$${bet}`;
    document.getElementById('player-score').innerText = getScore(pHand);
}

// --- è§†è§‰å¼•æ“é€»è¾‘ ---
const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
hands.onResults((res) => {
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.scale(-1, 1); ctx.translate(-canvas.width, 0);
    ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
    if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
        const lm = res.multiHandLandmarks[0];
        drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#d4af37', lineWidth: 2});
        const up = (i) => lm[i].y < lm[i-2].y;
        let type = (up(8) && !up(12)) ? "HIT" : (up(8) && up(12) && up(16) ? "STAND" : "NONE");
        action(type);
    }
    ctx.restore();
});

const camera = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 640, height: 480 });
window.onload = () => {
    canvas.width = 220; canvas.height = 165;
    camera.start().then(() => {
        document.getElementById('main-hint').innerHTML = "â˜ï¸ ä¿æŒé£ŸæŒ‡ï¼šä¸‹æ³¨ ($100) | ğŸ–ï¸ ä¿æŒæ‰‹æŒï¼šç¡®è®¤å¼€å±€";
        updateUI();
    });
};
</script>
</body>
</html>
